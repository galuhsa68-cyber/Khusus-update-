<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Save Kontak</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#8e2de2">
  <link rel="icon" href="android-chrome-192x192.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      transition: background 0.6s ease, color 0.6s ease;
      padding-bottom: 60px;
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 400px;
      margin-top: 50px;
      text-align: center;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      outline: none;
      font-family: "Poppins", sans-serif;
    }
    button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { opacity: 0.9; transform: scale(1.02); }
    #app, #dataPage, #profilePage, #historyPage { display: none; }
    .hidden { display: none; }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 55px;
      background: rgba(0,0,0,0.7);
      display: flex; justify-content: space-around; align-items: center;
      color: #fff; font-weight: 600;
      z-index: 10; backdrop-filter: blur(8px);
    }
    .bottom-nav button {
      flex: 1; background: transparent; border: none;
      color: inherit; font-size: 14px; padding: 10px;
    }
    .bottom-nav button.active { color: #ffd700; }

    /* Tema */
    body.royal { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: #f5f5f5; }
    body.royal button { background: #6a11cb; color: #fff; }

    body.platinum { background: #f8f9fb; color: #222; }
    body.platinum .card { background: rgba(0,0,0,0.05); }
    body.platinum button { background: #8e2de2; color: #fff; }

    body.galaxy { background: radial-gradient(circle at top left, #000428, #004e92); color: #fff; }
    body.galaxy button { background: #8a2be2; box-shadow: 0 0 10px #00d4ff; color: #fff; }

    body.blackgold { background: #000; color: #FFD700; }
    body.blackgold button { background: #222; border: 1px solid #FFD700; color: #FFD700; }

    /* small adjustments for lists */
    #dataContent ul, #historyContent ul { text-align: left; padding-left: 18px; }
    #historyContent li { margin-bottom: 10px; }
    .owner-section { text-align: left; }
  </style>
</head>
<body class="royal">
  <!-- Login -->
  <div class="card" id="loginCard">
    <h2>Login / Daftar</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="register()">Daftar</button>
  </div>

  <!-- App -->
  <div id="app" class="card">
    <h2>Halo, <span id="userDisplay"></span> üëã</h2>

    <textarea id="numberInput" placeholder="Masukkan nomor (pisahkan dengan baris atau koma)" rows="8"></textarea>
    <button onclick="saveMultipleContacts()">Simpan Kontak</button>
    <button onclick="checkNumber()">Cek Nomor</button>
    <button onclick="checkContactOrder()">Cek Urutan Kontak</button>
    <button onclick="resetNumber()">Reset Kontak</button>
    <button onclick="restoreDeleted()">Pulihkan Kontak Terhapus</button>
    <button onclick="exportVCF()">Export .VCF</button>

    <div id="ownerMenu" class="hidden owner-section">
      <hr><h3>üé® Ganti Tema (Owner)</h3>
      <select id="themeSelector" onchange="changeTheme(this.value)">
        <option value="royal">Royal Dark Glass</option>
        <option value="platinum">Platinum Light</option>
        <option value="galaxy">Neo Galaxy</option>
        <option value="blackgold">Black Gold Prestige</option>
      </select>

      <hr><h3>Menu Owner</h3>
      <button onclick="showPending()">Lihat Pending</button>
      <button onclick="approveAll()">ACC Semua Pending</button>
      <button onclick="angkatJabatan()">Angkat Jabatan (Nama Bebas)</button>
      <button onclick="showAllUsers()">Lihat Semua User</button>
      <button onclick="showAllContacts()">Lihat Semua Kontak</button>
      <button onclick="viewUserContacts()">Lihat Kontak User Tertentu</button>
      <button onclick="checkContactOrder(true)">Cek Urutan Semua Kontak</button>
      <button onclick="showAllHistory()">Lihat Riwayat Semua User</button>
      <hr>
    </div>

    <div id="moderatorMenu" class="hidden owner-section">
      <hr><h3>üß© Menu Moderator</h3>
      <button onclick="showPending()">Lihat Pending</button>
      <button onclick="approveAll()">ACC Semua Pending</button>
    </div>

    <hr><button onclick="logout()">Keluar</button>
  </div>

  <!-- Data Page -->
  <div id="dataPage" class="card">
    <h2>üìã Data Kontak</h2>
    <div id="dataContent">Memuat data...</div>
  </div>

  <!-- History Page -->
  <div id="historyPage" class="card">
    <h2>üïì Riwayat Kontak</h2>
    <input type="text" id="searchHistory" placeholder="Cari nama atau nomor..." oninput="filterHistory()">
    <div id="historyContent">Memuat riwayat...</div>
    <div style="margin-top:8px"><button onclick="exportHistoryVCF()">Export Riwayat ke .VCF</button></div>
  </div>

  <!-- Profile Page -->
  <div id="profilePage" class="card">
    <h2>üë§ Profil Akun</h2>
    <p><b>Username:</b> <span id="profileUser"></span></p>
    <p><b>Role:</b> <span id="profileRole"></span></p>
    <p id="profileNote" style="font-size:0.9em;color:inherit"></p>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav hidden" id="bottomNav">
    <button id="navHome" class="active" onclick="showSection('home')">üè† Home</button>
    <button id="navData" onclick="showSection('data')">üìÑ Data</button>
    <button id="navHistory" onclick="showSection('history')"> Riwayat</button>
    <button id="navProfile" onclick="showSection('profil')">üë§ Profil akun</button>
  </div>

  <!-- SCRIPT -->
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBdYYNycKp2k31JLulxHuEiaTSFRGnqfVI",
    authDomain: "save-kontak-januari.firebaseapp.com",
    databaseURL: "https://save-kontak-januari-default-rtdb.firebaseio.com",
    projectId: "save-kontak-januari",
    storageBucket: "save-kontak-januari.firebasestorage.app",
    messagingSenderId: "750268824578",
    appId: "1:750268824578:web:7db443a541552fa12f7b1b",
    measurementId: "G-F58LMSKKYR"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

    // Owner default (tetap sama)
    const OWNER = { username: "Sofi", password: "sofi" };

    // Elements
    const loginCard = document.getElementById("loginCard");
    const appDiv = document.getElementById("app");
    const userDisplay = document.getElementById("userDisplay");
    const ownerMenu = document.getElementById("ownerMenu");
    const moderatorMenu = document.getElementById("moderatorMenu");
    const themeSelector = document.getElementById("themeSelector");
    const bottomNav = document.getElementById("bottomNav");
    const dataPage = document.getElementById("dataPage");
    const dataContent = document.getElementById("dataContent");
    const profilePage = document.getElementById("profilePage");
    const profileUser = document.getElementById("profileUser");
    const profileRole = document.getElementById("profileRole");
    const profileNote = document.getElementById("profileNote");
    const numberInput = document.getElementById("numberInput");
    const historyPage = document.getElementById("historyPage");
    const historyContent = document.getElementById("historyContent");

    // ===== THEME =====
    async function changeTheme(theme){
      await set(ref(db,"settings/theme"), theme);
      alert("Tema diubah ke: "+theme);
    }
    function applyTheme(theme){
      document.body.className = theme;
      if(themeSelector) themeSelector.value = theme;
    }
    onValue(ref(db,"settings/theme"), (s) => applyTheme(s.val() || "royal"));

    // ===== REGISTER =====
    async function register(){
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if(!username || !password) return alert("Isi semua kolom!");
      if(username === OWNER.username) return alert("Nama ini hanya untuk owner!");
      const uRef = ref(db, "users/" + username);
      const s = await get(uRef);
      if(s.exists()) return alert("Username sudah ada!");
      // default: not approved, role user, not moderator
      await set(uRef, { username, password, approved: false, role: "user", isModerator: false });
      alert("Akun berhasil dibuat, hubungi putragaluh14 untuk minta di ACC!");
    }

    // ===== LOGIN =====
    async function login(){
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if(!username || !password) return alert("Isi username dan password!");

      // Owner login (hard-coded)
      if(username === OWNER.username && password === OWNER.password){
        localStorage.setItem("user", username);
        openApp({ username, role: "owner", isModerator: false });
        return alert("Login OWNER!");
      }

      const s = await get(ref(db, "users/" + username));
      if(!s.exists()) return alert("Akun tidak ditemukan!");
      const data = s.val();
      if(data.password !== password) return alert("Password salah!");
      if(!data.approved) return alert("Belum di ACC!");
      localStorage.setItem("user", username);
      openApp({ username, role: data.role || "user", isModerator: !!data.isModerator });
      alert("Login berhasil!");
    }

    // ===== OPEN APP (setup menu sesuai role) =====
    function openApp(userObj){
      // userObj: { username, role, isModerator }
      loginCard.style.display = "none";
      appDiv.style.display = "block";
      bottomNav.classList.remove("hidden");
      dataPage.style.display = "none";
      profilePage.style.display = "none";
      historyPage.style.display = "none";

      userDisplay.textContent = localStorage.getItem("user");

      ownerMenu.classList.add("hidden");
      moderatorMenu.classList.add("hidden");

      if(userObj.role === "owner") {
        ownerMenu.classList.remove("hidden");
      } else if(userObj.isModerator) {
        moderatorMenu.classList.remove("hidden");
      }
    }

    function logout(){
      localStorage.removeItem("user");
      appDiv.style.display = "none";
      dataPage.style.display = "none";
      profilePage.style.display = "none";
      historyPage.style.display = "none";
      bottomNav.classList.add("hidden");
      loginCard.style.display = "block";
    }

    // ===== SAVE MULTIPLE CONTACTS (plus riwayat) =====
    async function saveMultipleContacts() {
  const user = localStorage.getItem("user");
  const numberText = numberInput.value.trim();

  if (!user) return alert("Login dulu!");
  if (!numberText) return alert("Masukkan nomor dulu!");

  const numbers = numberText
    .split(/[\n,]+/)
    .map(n => n.trim())
    .filter(n => n !== "");

  const contactRef = ref(db, "contacts/" + user);
  const snap = await get(contactRef);

  // handle previous contacts - bisa array atau object
  const prev = snap.exists() ? snap.val() : [];
  const arr = Array.isArray(prev) ? prev.slice() : Object.values(prev || {});

  // hanya tanggal, tidak ada jam
  const now = new Date();
  const dateString = now.toLocaleDateString("id-ID", { timeZone: "Asia/Jakarta" });

  const updated = [...arr];
  const newHistory = [];

  numbers.forEach(num => {
    const index = updated.length + 1;
    const contact = {
      name: `Kontak ${index} (${dateString})`,
      number: num,
      date: dateString
    };

    updated.push(contact);
    newHistory.push(contact);
  });

  // Simpan kontak
  await set(contactRef, updated);

  // Simpan ke riwayat (tidak menghapus yang lama)
  const historyRef = ref(db, "contactHistory/" + user);
  const hSnap = await get(historyRef);
  const oldHistory = hSnap.exists()
    ? (Array.isArray(hSnap.val()) ? hSnap.val() : Object.values(hSnap.val()))
    : [];
  const merged = [...oldHistory, ...newHistory];

  await set(historyRef, merged);

  alert(`${numbers.length} kontak berhasil disimpan! Riwayat juga diperbarui.`);
  numberInput.value = "";
}

    // ===== CHECK NUMBER (count) =====
    async function checkNumber(){
      const user = localStorage.getItem("user");
      if(!user) return alert("Login dulu!");
      const s = await get(ref(db, "contacts/" + user));
      if(!s.exists()) return alert("Belum ada kontak!");
      const arr = Array.isArray(s.val()) ? s.val() : Object.values(s.val());
      alert("Total kontak: " + arr.length);
    }

    // ===== CHECK CONTACT ORDER =====
    async function checkContactOrder(all = false){
      if(all){
        const s = await get(ref(db, "contacts"));
        if(!s.exists()) return alert("Belum ada data!");
        let text = "";
        for(const [u, arr] of Object.entries(s.val())) {
          const count = Array.isArray(arr) ? arr.length : Object.values(arr).length;
          text += `${u}: ${count} kontak\n`;
        }
        alert(text);
      } else {
        const user = localStorage.getItem("user");
        if(!user) return alert("Login dulu!");
        const s = await get(ref(db, "contacts/" + user));
        if(!s.exists()) return alert("Belum ada kontak!");
        const arr = Array.isArray(s.val()) ? s.val() : Object.values(s.val());
        alert("Kontakmu urut dari 1 sampai " + arr.length);
      }
    }

    // ===== RESET CONTACTS (backup then remove) =====
    async function resetNumber(){
      const user = localStorage.getItem("user");
      if(!user) return alert("Login dulu!");
      const s = await get(ref(db, "contacts/" + user));
      if(!s.exists()) return alert("Tidak ada kontak untuk dihapus!");
      if(confirm("Yakin ingin reset semua kontak?")){
        await set(ref(db, "backupContacts/" + user), s.val());
        await remove(ref(db, "contacts/" + user));
        alert("Kontak dihapus, tapi sudah dibackup dan bisa dipulihkan!");
      }
    }

    // ===== RESTORE =====
    async function restoreDeleted(){
      const user = localStorage.getItem("user");
      if(!user) return alert("Login dulu!");
      const s = await get(ref(db, "backupContacts/" + user));
      if(!s.exists()) return alert("Tidak ada backup untuk dipulihkan!");
      await set(ref(db, "contacts/" + user), s.val());
      alert("Kontak berhasil dipulihkan dari backup!");
    }

    // ===== EXPORT VCF (current contacts) =====
    async function exportVCF(){
      const user = localStorage.getItem("user");
      if(!user) return alert("Login dulu!");
      const s = await get(ref(db, "contacts/" + user));
      if(!s.exists()) return alert("Tidak ada kontak!");
      const prev = s.val();
      const arr = Array.isArray(prev) ? prev : Object.values(prev);
      let vcf = "";
      arr.forEach(c => {
        vcf += `BEGIN:VCARD\nVERSION:3.0\nFN:${c.name}\nTEL:${c.number}\nEND:VCARD\n`;
      });
      const blob = new Blob([vcf], { type: "text/vcard" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "contacts.vcf";
      a.click();
    }

    // ===== EXPORT HISTORY VCF =====
    async function exportHistoryVCF(){
      const user = localStorage.getItem("user");
      if(!user) return alert("Login dulu!");
      // For owner, export all history; for normal user, export own history
      if(user === OWNER.username){
        const s = await get(ref(db, "contactHistory"));
        if(!s.exists()) return alert("Belum ada riwayat.");
        let vcf = "";
        for(const [u, arr] of Object.entries(s.val())){
          const list = Array.isArray(arr) ? arr : Object.values(arr);
          list.forEach(c => vcf += `BEGIN:VCARD\nVERSION:3.0\nFN:${c.name} (${u})\nTEL:${c.number}\nEND:VCARD\n`);
        }
        const blob = new Blob([vcf], { type: "text/vcard" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "history_all.vcf";
        a.click();
      } else {
        const s = await get(ref(db, "contactHistory/" + user));
        if(!s.exists()) return alert("Belum ada riwayat.");
        const arr = Array.isArray(s.val()) ? s.val() : Object.values(s.val());
        let vcf = "";
        arr.forEach(c => vcf += `BEGIN:VCARD\nVERSION:3.0\nFN:${c.name}\nTEL:${c.number}\nEND:VCARD\n`);
        const blob = new Blob([vcf], { type: "text/vcard" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "history_my.vcf";
        a.click();
      }
    }

    // ===== OWNER: SHOW PENDING =====
    async function showPending(){
      const s = await get(ref(db, "users"));
      if(!s.exists()) return alert("Belum ada user.");
      const arr = Object.values(s.val()).filter(u => !u.approved);
      alert(arr.length ? arr.map(u => u.username).join(", ") : "Tidak ada pending.");
    }

    // ===== APPROVE ALL PENDING =====
    async function approveAll(){
      const s = await get(ref(db, "users"));
      if(!s.exists()) return;
      for(const [u,v] of Object.entries(s.val())){
        if(!v.approved) await update(ref(db, "users/" + u), { approved: true });
      }
      alert("Semua user di ACC!");
    }

    // ===== SHOW ALL USERS =====
    async function showAllUsers(){
      const s = await get(ref(db, "users"));
      if(!s.exists()) return alert("Tidak ada user.");
      alert(Object.keys(s.val()).join(", "));
    }

    // ===== SHOW ALL CONTACTS (owner) =====
    async function showAllContacts(){
      // menampilkan di halaman data grouped by user
      showSection('data'); // loadDataPage handles owner view
    }

    // ===== VIEW USER CONTACTS =====
    async function viewUserContacts(){
      const nama = prompt("Masukkan username:");
      if(!nama) return;
      const s = await get(ref(db, "contacts/" + nama));
      if(!s.exists()) return alert("Tidak ada kontak!");
      const arr = Array.isArray(s.val()) ? s.val() : Object.values(s.val());
      alert(arr.map(c => `${c.name}: ${c.number}`).join("\n"));
    }

    // ===== ANGGAT JABATAN (Owner) - Nama Bebas =====
    async function angkatJabatan(){
      const nama = prompt("Masukkan username yang ingin diangkat:");
      if(!nama) return alert("Dibatalkan");
      const jabatan = prompt("Masukkan nama jabatan (bebas, cont: Admin, Manager, Moderator):");
      if(!jabatan) return alert("Dibatalkan");
      const s = await get(ref(db, "users/" + nama));
      if(!s.exists()) return alert("User tidak ditemukan!");
      // kita set role = jabatan, dan tandai isModerator = true supaya user punya akses moderator
      await update(ref(db, "users/" + nama), { role: jabatan, isModerator: true, approved: true });
      alert(`${nama} telah diangkat menjadi "${jabatan}" dan di-ACC otomatis!`);
    }

    // ===== DATA PAGE loading =====
    async function loadDataPage(){
      const user = localStorage.getItem("user");
      if(!user) return;
      dataContent.innerHTML = "Memuat data...";
      // if owner -> show all contacts grouped by user
      if(user === OWNER.username){
        const s = await get(ref(db, "contacts"));
        if(!s.exists()) return dataContent.innerHTML = "Belum ada data.";
        let html = "";
        const all = s.val();
        for(const [u, arr] of Object.entries(all)){
          const list = Array.isArray(arr) ? arr : Object.values(arr);
          html += `<h3>üë§ ${u} (${list.length} kontak)</h3><ul>`;
          list.forEach(c => html += `<li>${c.name} - ${c.number}</li>`);
          html += `</ul><hr>`;
        }
        dataContent.innerHTML = html;
      } else {
        const s = await get(ref(db, "contacts/" + user));
        if(!s.exists()) return dataContent.innerHTML = "Belum ada kontak.";
        const arr = Array.isArray(s.val()) ? s.val() : Object.values(s.val());
        dataContent.innerHTML = `<ul>${arr.map(c => `<li>${c.name} - ${c.number}</li>`).join("")}</ul>`;
      }
    }

    // ===== LOAD HISTORY PAGE =====
    async function loadHistoryPage(){
      const user = localStorage.getItem("user");
      if(!user) return;
      // Owner: load all history grouped by user
      if(user === OWNER.username){
        const s = await get(ref(db, "contactHistory"));
        if(!s.exists()) return historyContent.innerHTML = "Belum ada riwayat.";
        const all = s.val();
        // flatten into list with owner tag for search convenience
        const merged = [];
        let html = "";
        for(const [u, arr] of Object.entries(all)){
          const list = Array.isArray(arr) ? arr : Object.values(arr);
          html += `<h3>üë§ ${u} (${list.length})</h3><ul>`;
          list.forEach(c => {
            merged.push({...c, owner:u});
            html += `<li><b>${c.name}</b><br>${c.number}<br><small>${c.date||""}</small></li>`;
          });
          html += `</ul><hr>`;
        }
        historyContent.innerHTML = html;
        window.fullHistory = merged; // for search across all
      } else {
        const s = await get(ref(db, "contactHistory/" + user));
        if(!s.exists()) return historyContent.innerHTML = "Belum ada riwayat.";
        const arr = Array.isArray(s.val()) ? s.val() : Object.values(s.val());
        window.fullHistory = arr;
        renderHistoryList(arr);
      }
    }

    function renderHistoryList(list){
      if(!list || list.length === 0){
        historyContent.innerHTML = "Tidak ada riwayat.";
        return;
      }
      // if items have 'owner' field (owner view), group by owner for nicer view
      if(list[0] && list[0].owner){
        // owner already sets historyContent in loadHistoryPage; but for search results, render grouped
        const grouped = {};
        list.forEach(item => {
          if(!grouped[item.owner]) grouped[item.owner] = [];
          grouped[item.owner].push(item);
        });
        let html = "";
        for(const u of Object.keys(grouped)){
          html += `<h3>üë§ ${u} (${grouped[u].length})</h3><ul>`;
          grouped[u].forEach(c => html += `<li><b>${c.name}</b><br>${c.number}<br><small>${c.date||""}</small></li>`);
          html += `</ul><hr>`;
        }
        historyContent.innerHTML = html;
      } else {
        // normal user list
        historyContent.innerHTML = "<ul>" + list.map(c => `<li><b>${c.name}</b><br>${c.number}<br><small>${c.date||""}</small></li>`).join("") + "</ul>";
      }
    }

    function filterHistory(){
      const q = document.getElementById("searchHistory").value.toLowerCase();
      const list = (window.fullHistory || []).filter(c => {
        const name = (c.name || "").toString().toLowerCase();
        const num = (c.number || "").toString();
        const owner = (c.owner || "").toString().toLowerCase();
        return name.includes(q) || num.includes(q) || owner.includes(q);
      });
      renderHistoryList(list);
    }

    // Owner helper: show all history (shortcut)
    async function showAllHistory(){
      showSection('history');
    }

    // ===== PROFILE PAGE loading =====
    async function loadProfile(){
      const user = localStorage.getItem("user");
      if(!user) return;
      profileUser.textContent = user;
      if(user === OWNER.username){
        profileRole.textContent = "Owner";
        profileNote.textContent = "Akses penuh (Owner).";
      } else {
        const s = await get(ref(db, "users/" + user));
        if(!s.exists()){
          profileRole.textContent = "User";
          profileNote.textContent = "";
        } else {
          const data = s.val();
          profileRole.textContent = data.role || "User";
          if(data.isModerator) profileNote.textContent = "Catatan: User ini punya hak moderator (lihat & ACC pending).";
          else profileNote.textContent = "";
        }
      }
    }

    // ===== NAVIGATION =====
    function showSection(sec){
      document.querySelectorAll(".bottom-nav button").forEach(b => b.classList.remove("active"));
      appDiv.style.display = "none";
      dataPage.style.display = "none";
      profilePage.style.display = "none";
      historyPage.style.display = "none";

      if(sec === "home"){
        appDiv.style.display = "block";
        document.getElementById("navHome").classList.add("active");
      } else if(sec === "data"){
        dataPage.style.display = "block";
        document.getElementById("navData").classList.add("active");
        loadDataPage();
      } else if(sec === "history"){
        historyPage.style.display = "block";
        document.getElementById("navHistory").classList.add("active");
        loadHistoryPage();
      } else if(sec === "profile"){
        profilePage.style.display = "block";
        document.getElementById("navProfile").classList.add("active");
        loadProfile();
      }
    }

    // ===== AUTO CHECK ON LOAD (keadaan sudah login) =====
    window.addEventListener("DOMContentLoaded", async () => {
      const user = localStorage.getItem("user");
      if(user){
        // owner?
        if(user === OWNER.username){
          openApp({ username: user, role: "owner", isModerator: false });
        } else {
          const s = await get(ref(db, "users/" + user));
          if(s.exists()){
            const data = s.val();
            openApp({ username: user, role: data.role || "user", isModerator: !!data.isModerator });
          } else {
            openApp({ username: user, role: "user", isModerator: false });
          }
        }
      }
    });

    // ===== EXPORT GLOBALS =====
    window.login = login;
    window.register = register;
    window.logout = logout;

    window.saveMultipleContacts = saveMultipleContacts;
    window.checkNumber = checkNumber;
    window.checkContactOrder = checkContactOrder;
    window.resetNumber = resetNumber;
    window.restoreDeleted = restoreDeleted;
    window.exportVCF = exportVCF;

    window.showPending = showPending;
    window.approveAll = approveAll;
    window.showAllUsers = showAllUsers;
    window.showAllContacts = showAllContacts;
    window.viewUserContacts = viewUserContacts;
    window.angkatJabatan = angkatJabatan;

    window.changeTheme = changeTheme;
    window.showSection = showSection;
    window.loadDataPage = loadDataPage;
    window.filterHistory = filterHistory;
    window.showAllHistory = showAllHistory;
    window.exportHistoryVCF = exportHistoryVCF;
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('‚úÖ Service Worker terdaftar:', reg.scope))
    .catch(err => console.error('‚ùå Gagal daftar SW:', err));

  // üîî Dengarkan notifikasi dari Service Worker
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data && event.data.type === 'NEW_VERSION_AVAILABLE') {
      showUpdateToast();
    }
  });
}

// üé® Fungsi tampilkan toast (notifikasi update)
function showUpdateToast() {
  // Buat elemen toast
  const toast = document.createElement('div');
  toast.innerHTML = `
    <div style="
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4f46e5;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      font-family: sans-serif;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 12px;
    ">
      <span>üîÅ Versi baru tersedia!</span>
      <button id="refreshApp" style="
        background: white;
        color: #4f46e5;
        border: none;
        border-radius: 6px;
        padding: 6px 10px;
        font-weight: bold;
        cursor: pointer;
      ">Perbarui Sekarang</button>
    </div>
  `;
  document.body.appendChild(toast);

  // Klik tombol ‚Üí reload & update PWA
  document.getElementById('refreshApp').addEventListener('click', async () => {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg && reg.waiting) {
      reg.waiting.postMessage({ type: 'SKIP_WAITING' });
    }
    window.location.reload();
  });
}
  </script>

  <script>
    // Paksa fullscreen saat dibuka dari PWA
    window.addEventListener('load', () => {
      if (window.matchMedia('(display-mode: browser)').matches) {
        console.log('Mode browser - tidak fullscreen');
      } else {
        const el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      }
    });
  </script>
</body>
</html>
